
import React, { useState, useEffect } from 'react';
import { X, Save, AlertCircle, ChevronDown, ChevronUp } from 'lucide-react';
import { Category, License } from '../types';
import { createClient } from '@/lib/supabase/client';

interface LicenseFormModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
  initialData?: License | null; // If provided, it's Edit mode
  categories: Category[];
}

export const LicenseFormModal: React.FC<LicenseFormModalProps> = ({
  isOpen,
  onClose,
  onSuccess,
  initialData,
  categories
}) => {
  const supabase = createClient();
  const [formData, setFormData] = useState({
    license_number: '',
    expire_date: '',
    category_id: '',
    new_category_name: '',
    // Detailed fields
    company: '',
    tag: '',
    standard_scope: '',
    criteria_scope: '',
    certification_authority: '',
    effective_date: ''
  });

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showDetails, setShowDetails] = useState(true);

  // Load initial data when editing
  useEffect(() => {
    if (initialData) {
      setFormData({
        license_number: initialData.license_number,
        expire_date: initialData.expire_date,
        category_id: initialData.category_id.toString(),
        new_category_name: '',
        company: initialData.company || '',
        tag: initialData.tag || '',
        standard_scope: initialData.standard_scope || '',
        criteria_scope: initialData.criteria_scope || '',
        certification_authority: initialData.certification_authority || '',
        effective_date: initialData.effective_date || ''
      });
    } else {
      // Reset for Create mode
      setFormData({
        license_number: '',
        expire_date: '',
        category_id: '',
        new_category_name: '',
        company: '',
        tag: '',
        standard_scope: '',
        criteria_scope: '',
        certification_authority: '',
        effective_date: ''
      });
    }
    setError(null);
  }, [initialData, isOpen]);

  if (!isOpen) return null;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("User not found");

      let finalCategoryId = formData.category_id;

      // 1. Handle New Category Creation
      if (formData.category_id === 'new') {
        if (!formData.new_category_name.trim()) throw new Error("Category name is required");

        const { data: newCat, error: catError } = await supabase
          .from('license_categories')
          .insert({ name: formData.new_category_name, user_id: user.id })
          .select()
          .single();

        if (catError) throw catError;
        finalCategoryId = newCat.id;
      }

      // 2. Insert or Update License
      const payload = {
        license_number: formData.license_number,
        expire_date: formData.expire_date,
        category_id: parseInt(finalCategoryId),
        user_id: user.id,
        status: 'Active',
        // Optional detailed fields
        company: formData.company || null,
        tag: formData.tag || null,
        standard_scope: formData.standard_scope || null,
        criteria_scope: formData.criteria_scope || null,
        certification_authority: formData.certification_authority || null,
        effective_date: formData.effective_date || null,
      };

      if (initialData) {
        // UPDATE
        const { error: updateError } = await supabase
          .from('licenses')
          .update(payload)
          .eq('id', initialData.id);
        if (updateError) throw updateError;
      } else {
        // CREATE
        const { error: insertError } = await supabase
          .from('licenses')
          .insert(payload);
        if (insertError) throw insertError;
      }

      onSuccess();
      onClose();
    } catch (err: any) {
      setError(err.message || "An error occurred");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
      <div className="bg-white rounded-xl shadow-xl max-w-2xl w-full overflow-hidden max-h-[90vh] flex flex-col">
        {/* Header */}
        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <h2 className="text-lg font-bold text-gray-800">
            {initialData ? 'แก้ไขใบอนุญาต (Edit License)' : 'เพิ่มใบอนุญาตใหม่ (Add License)'}
          </h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
            <X size={20} />
          </button>
        </div>

        {/* Body */}
        <form onSubmit={handleSubmit} className="p-6 overflow-y-auto custom-scrollbar">
          {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-start gap-2 mb-4">
              <AlertCircle size={16} className="mt-0.5 shrink-0" />
              <span>{error}</span>
            </div>
          )}

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">

            {/* Section 1: Core Info */}
            <div className="col-span-full space-y-4">
              <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider border-b pb-1">Main Information</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">เลขที่ใบอนุญาต (License No.) <span className="text-red-500">*</span></label>
                  <input
                    required
                    type="text"
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                    placeholder="e.g. ACFS-2024-001"
                    value={formData.license_number}
                    onChange={(e) => setFormData({ ...formData, license_number: e.target.value })}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ประเภท (Category) <span className="text-red-500">*</span></label>
                  <select
                    required
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white transition-all"
                    value={formData.category_id}
                    onChange={(e) => setFormData({ ...formData, category_id: e.target.value })}
                  >
                    <option value="">-- เลือกประเภท --</option>
                    {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    <option value="new" className="font-bold text-blue-600">+ เพิ่มประเภทใหม่</option>
                  </select>
                </div>
              </div>

              {formData.category_id === 'new' && (
                <div className="animate-in slide-in-from-top-2 duration-200">
                  <label className="block text-sm font-medium text-blue-700 mb-1">ชื่อประเภทใหม่ (New Category Name)</label>
                  <input
                    required
                    type="text"
                    className="w-full border-2 border-blue-100 bg-blue-50 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                    placeholder="ระบุชื่อประเภท..."
                    value={formData.new_category_name}
                    onChange={(e) => setFormData({ ...formData, new_category_name: e.target.value })}
                  />
                </div>
              )}
            </div>

            {/* Section 2: Organization Info */}
            <div className="col-span-full md:col-span-1 space-y-4">
              <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider border-b pb-1 mt-2">Organization</h3>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">บริษัท (Company)</label>
                <input
                  type="text"
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                  placeholder="Company Name"
                  value={formData.company}
                  onChange={(e) => setFormData({ ...formData, company: e.target.value })}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">หน่วยงานผู้ออกใบ (Authority)</label>
                <input
                  type="text"
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                  placeholder="e.g. กรมวิชาการเกษตร"
                  value={formData.certification_authority}
                  onChange={(e) => setFormData({ ...formData, certification_authority: e.target.value })}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Tag (ตัวย่อ)</label>
                <input
                  type="text"
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                  placeholder="e.g. DOA, GAP"
                  value={formData.tag}
                  onChange={(e) => setFormData({ ...formData, tag: e.target.value })}
                />
              </div>
            </div>

            {/* Section 3: Dates & Scopes */}
            <div className="col-span-full md:col-span-1 space-y-4">
              <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider border-b pb-1 mt-2">Details & Duration</h3>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">วันที่มีผล (Effective)</label>
                  <input
                    type="date"
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.effective_date}
                    onChange={(e) => setFormData({ ...formData, effective_date: e.target.value })}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">วันหมดอายุ (Expiry) <span className="text-red-500">*</span></label>
                  <input
                    required
                    type="date"
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none border-l-4 border-l-blue-500"
                    value={formData.expire_date}
                    onChange={(e) => setFormData({ ...formData, expire_date: e.target.value })}
                  />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ขอบข่ายมาตรฐาน (Standard Scope)</label>
                <input
                  type="text"
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                  placeholder="e.g. มกษ. 9001"
                  value={formData.standard_scope}
                  onChange={(e) => setFormData({ ...formData, standard_scope: e.target.value })}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ขอบข่ายรายละเอียดย่อย (Criteria)</label>
                <input
                  type="text"
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                  placeholder="e.g. ผลิตพืชอาหาร"
                  value={formData.criteria_scope}
                  onChange={(e) => setFormData({ ...formData, criteria_scope: e.target.value })}
                />
              </div>
            </div>

          </div>

          {/* Actions */}
          <div className="flex gap-3 mt-8 pt-4 border-t border-gray-100">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors"
              disabled={loading}
            >
              ยกเลิก
            </button>
            <button
              type="submit"
              disabled={loading}
              className="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition-all flex items-center justify-center gap-2"
            >
              {loading ? (
                <span className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
              ) : (
                <>
                  <Save size={18} />
                  บันทึกข้อมูล
                </>
              )}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
